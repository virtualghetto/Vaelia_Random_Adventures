#textdomain wesnoth-Vaelia_Random_Adventures

#define VRA_VILLAGE NAME MESSAGE
[event]
	name=moveto
	first_time_only=no

	[filter]
		side=1
		[filter_location]
			location_id="{NAME}"
		[/filter_location]
	[/filter]

	[fire_event]
		name=vra_select_endlevel
		[primary_unit]
			id=$unit.id
		[/primary_unit]
		[primary_attack]
			map={NAME}
			map_message={MESSAGE}
		[/primary_attack]
	[/fire_event]
[/event]
#enddef

[scenario]
	#must match first_scenario in _main.cfg
	id=01_vra_select

	# final scenario should be null
	next_scenario=null
	name=_ "Select where to go next"
	map_data="{~add-ons/Vaelia_Random_Adventures/maps/01_vra_select.map}"

	# number of turns. -1 for no limit.
	turns=16

	{SCENARIO_MUSIC "transience.ogg"}
	{EXTRA_SCENARIO_MUSIC "nunc_dimittis.ogg"}
	{EXTRA_SCENARIO_MUSIC "the_king_is_dead.ogg"}
	{EXTRA_SCENARIO_MUSIC "loyalists.ogg"}
	{EXTRA_SCENARIO_MUSIC "traveling_minstrels.ogg"}
	{EXTRA_SCENARIO_MUSIC "wanderer.ogg"}
	{EXTRA_SCENARIO_MUSIC "elvish-theme.ogg"}
	{EXTRA_SCENARIO_MUSIC "journeys_end.ogg"}
	{EXTRA_SCENARIO_MUSIC "silvan_sanctuary.ogg"}
	{EXTRA_SCENARIO_MUSIC "knolls.ogg"}

	{DEFAULT_SCHEDULE}

	random_start_time=yes
	victory_when_enemies_defeated=no
	carryover_percentage=100
	carryover_add=no

	[label]
		x,y=14,8
		text= _ "Plain"
	[/label]

	[label]
		x,y=10,6
		text= _ "Cave"
	[/label]

	[label]
		x,y=10,4
		text= _ "Volcano"
	[/label]

	[label]
		x,y=6,8
		text= _ "Winter"
	[/label]

	[label]
		x,y=6,12
		text= _ "Marsh"
	[/label]

	[label]
		x,y=14,12
		text= _ "Desert"
	[/label]

	[label]
		x,y=12,12
		text= _ "Sigurd"
	[/label]

	[label]
		x,y=8,12
		text= _ "WCII"
	[/label]

	[item]
		image="scenery/mine-abandoned.png"
		visible_in_fog=no
		x=10
		y=4
	[/item]

	[item]
		image="scenery/signpost.png"
		visible_in_fog=no
		x=12
		y=12
	[/item]

	[item]
		image="scenery/signpost.png"
		visible_in_fog=no
		x=8
		y=12
	[/item]

#	[item]
#		image="scenery/well.png"
#		visible_in_fog=no
#		x=10
#		y=13
#	[/item]

	{VRA_SELECT_ENDLEVEL_EVENT}

	{VRA_SIDE_ONE}

	[side]
		side=2
		controller=ai
		# Place leader, grant gold, income and recruits later
		no_leader=yes
		gold=0
		income=0
		# Set ai values later
		team_name=VaeliaTeam
		user_team_name= _ "Vaelia Allies"
	[/side]


	{VRA_CLEAR_VARIABLES_VICTORY}
	{VRA_CLEAR_VARIABLES_DEFEAT}

	[event]
		# event fired after player sees map
		name=prestart

		{VRA_SIDE_ONE_LEADER}

		[capture_village]
			side=1
			terrain=*^V*
		[/capture_village]

		{VARIABLE vra.enemy_faced $vra.enemy_faced}
		[if]
			{VARIABLE_CONDITIONAL vra.enemy_faced equals $null}
		[then]
			{CLEAR_VARIABLE vra.enemy_faced}
			{VARIABLE vra.enemy_faced 0}
			{CLEAR_VARIABLE vra.enemy_levelup}
			{VARIABLE vra.enemy_levelup no}
		[/then]
		[/if]

		{VARIABLE vra.round $vra.round}
		[if]
			{VARIABLE_CONDITIONAL vra.round equals $null}
		[then]
			{CLEAR_VARIABLE vra.round}
			{VARIABLE vra.round 0}
			[unit]
				side=1
				type=Peasant
				x,y=recall,recall
				generate_name=yes
				random_gender=yes
				random_traits=no
				[modifications]
					{TRAIT_LOYAL}
				[/modifications]
				{IS_LOYAL}
			[/unit]
		[/then]
		[/if]

		[objectives]
			side=1
			[objective]
				description= _ "Go to any village"
				condition=win
			[/objective]
			[objective]
				description= _ "Death of Vaelia... somehow"
				condition=lose
			[/objective]

			[gold_carryover]
				carryover_percentage=100
				bonus=no
			[/gold_carryover]

			{TURNS_RUN_OUT}

			[note]
				description="<b>" + _ "Round $vra.round|." + "</b>"
			[/note]
		[/objectives]

		[switch]
			variable=vra.round
		[case]
			value=0
			[terrain]
				[and]
					terrain=Ch
				[/and]
				terrain=Cte
			[/terrain]
			[terrain]
				[and]
					terrain=Kh
				[/and]
				terrain=Kte
			[/terrain]
		[/case]
		[case]
			value=1
			[terrain]
				[and]
					terrain=Ch
				[/and]
				terrain=Cte
			[/terrain]
			[terrain]
				[and]
					terrain=Kh
				[/and]
				terrain=Kte
			[/terrain]
		[/case]
		[case]
			value=2
			[terrain]
				[and]
					terrain=Ch
				[/and]
				terrain=Cer
			[/terrain]
			[terrain]
				[and]
					terrain=Kh
				[/and]
				terrain=Ker
			[/terrain]
		[/case]
		[case]
			value=3
			[terrain]
				[and]
					terrain=Ch
				[/and]
				terrain=Ce
			[/terrain]
			[terrain]
				[and]
					terrain=Kh
				[/and]
				terrain=Ke
			[/terrain]
		[/case]
		[case]
			value=4
			[terrain]
				[and]
					terrain=Ch
				[/and]
				terrain=Cea
			[/terrain]
			[terrain]
				[and]
					terrain=Kh
				[/and]
				terrain=Kea
			[/terrain]
		[/case]
		[case]
			value=5
			[terrain]
				[and]
					terrain=Ch
				[/and]
				terrain=Ce
			[/terrain]
			[terrain]
				[and]
					terrain=Kh
				[/and]
				terrain=Ket
			[/terrain]
		[/case]
		[case]
			value=6
			[terrain]
				[and]
					terrain=Ch
				[/and]
				terrain=Chr
			[/terrain]
			[terrain]
				[and]
					terrain=Kh
				[/and]
				terrain=Khr
			[/terrain]
		[/case]
		[else]
			{VARIABLE_OP do_cold rand "0..1"}
			[if]
				{VARIABLE_CONDITIONAL do_cold numerical_equals 1}
			[then]
				[terrain]
					[and]
						terrain=Ch
					[/and]
					terrain=Cha
				[/terrain]
				[terrain]
					[and]
						terrain=Kh
					[/and]
					terrain=Kha
				[/terrain]
			[/then]
			[/if]
			{CLEAR_VARIABLE do_cold}
		[/else]
		[/switch]

		[terrain]
			terrain=Gg^Wm
			x,y=10,13
		[/terrain]

		{VRA_GAME_LEVELUP_AFTER}
		[if]
			{VARIABLE_CONDITIONAL vra.round greater_than_equal_to 4}
		[then]
			[if]
				{VARIABLE_CONDITIONAL vra.enemy_faced greater_than_equal_to $vra.game_levelup_after}
			[then]
				{CLEAR_VARIABLE vra.enemy_levelup}
				{VARIABLE vra.enemy_levelup yes}
			[/then]
			[/if]
		[/then]
		[/if]
		{CLEAR_VARIABLE vra.game_levelup_after}

	[/event]

	[event]
		name=moveto
		first_time_only=yes
		[filter]
			side=1
			x,y=10,13
		[/filter]

		[if]
		{VARIABLE_CONDITIONAL vra.round greater_than 0}
		[then]
		[sound]
			name=gold.ogg
		[/sound]
		[set_variable]
			name=amount_gold
			value="$(min( [20000, (100 * $vra.round) ]))"
		[/set_variable]

		[gold]
			side=1
			amount=$amount_gold
		[/gold]

		[floating_text]
			x,y=10,13
			text= _ "$|$amount_gold|"
		[/floating_text]
		[delay]
			time=500
		[/delay]
		{CLEAR_VARIABLE amount_gold}
		[/then]
		[/if]
	[/event]

	{VRA_VILLAGE Cave _"Let's go underground..."}
	{VRA_VILLAGE Plain _"Plains it is..."}
	{VRA_VILLAGE Winter _"Brace yourself..."}
	{VRA_VILLAGE Marsh _"Make them eat mud..."}
	{VRA_VILLAGE Desert _"Bring lot's of water..."}
	{VRA_VILLAGE Volcano _"Tread lightly..."}
	{VRA_VILLAGE Sigurd _"Hmm... I guess we'll go with Sigurd's"}
	{VRA_VILLAGE WCII _"Hmm... I guess we'll go with WCII's"}

	[event]
		# Spaces in event names can be interchanged with underscores.
		# triggered when you run out of turns.
		name=time over
		[message]
			speaker=Vaelia
			message= _ "I give up. This is taking too long..."
		[/message]
		[endlevel]
			result=defeat
		[/endlevel]
	[/event]

	[event]
		name=start

[if]
	{VARIABLE_CONDITIONAL vra.is_recruit_set equals $null}
[then]
	{CLEAR_VARIABLE vra.is_recruit_set}
	{VARIABLE vra.is_recruit_set "no"}

	{CLEAR_VARIABLE vra.vaelia_recruit}
	{VARIABLE vra.vaelia_recruit ""}

	{CLEAR_VARIABLE vra.vaelia_demote1_type}
	{CLEAR_VARIABLE vra.vaelia_demote1_type1}

	{CLEAR_VARIABLE vra.vaelia_demote2_type}
	{CLEAR_VARIABLE vra.vaelia_demote2_type1}
	{CLEAR_VARIABLE vra.vaelia_demote2_type2}

	{CLEAR_VARIABLE vra.vaelia_demote3_type}
	{CLEAR_VARIABLE vra.vaelia_demote3_type1}
	{CLEAR_VARIABLE vra.vaelia_demote3_type2}
	{CLEAR_VARIABLE vra.vaelia_demote3_type3}


	{VARIABLE vra.vaelia_demote1_type ""}
	{VARIABLE vra.vaelia_demote1_type1 ""}

	{VARIABLE vra.vaelia_demote2_type ""}
	{VARIABLE vra.vaelia_demote2_type1 ""}
	{VARIABLE vra.vaelia_demote2_type2 ""}

	{VARIABLE vra.vaelia_demote3_type ""}
	{VARIABLE vra.vaelia_demote3_type1 ""}
	{VARIABLE vra.vaelia_demote3_type2 ""}
	{VARIABLE vra.vaelia_demote3_type3 ""}

	{VRA_INIT_DEMOTE}

[/then]
[/if]

[if]
	{VARIABLE_CONDITIONAL vra.is_recruit_set equals "no"}
[then]
	{CLEAR_VARIABLE vra.possible_recruit}
	{VRA_POSSIBLE_RECRUIT}
	{VARIABLE vra.is_recruit_set "yes"}
[/then]
[else]
	# Demote 3
	[set_variables]
		name=vra.vaelia_demote3_arr
		mode=replace
		[split]
			list=$vra.vaelia_demote3_type
			key=type
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote3_type}

	[set_variables]
		name=vra.vaelia_demote3_arr
		mode=merge
		[split]
			list=$vra.vaelia_demote3_type1
			key=type1
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote3_type1}

	[set_variables]
		name=vra.vaelia_demote3_arr
		mode=merge
		[split]
			list=$vra.vaelia_demote3_type2
			key=type2
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote3_type2}

	[set_variables]
		name=vra.vaelia_demote3_arr
		mode=merge
		[split]
			list=$vra.vaelia_demote3_type3
			key=type3
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote3_type3}

	# Demote 2
	[set_variables]
		name=vra.vaelia_demote2_arr
		mode=replace
		[split]
			list=$vra.vaelia_demote2_type
			key=type
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote2_type}

	[set_variables]
		name=vra.vaelia_demote2_arr
		mode=merge
		[split]
			list=$vra.vaelia_demote2_type1
			key=type1
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote2_type1}

	[set_variables]
		name=vra.vaelia_demote2_arr
		mode=merge
		[split]
			list=$vra.vaelia_demote2_type2
			key=type2
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote2_type2}

	# Demote 1
	[set_variables]
		name=vra.vaelia_demote1_arr
		mode=replace
		[split]
			list=$vra.vaelia_demote1_type
			key=type
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote1_type}

	[set_variables]
		name=vra.vaelia_demote1_arr
		mode=merge
		[split]
			list=$vra.vaelia_demote1_type1
			key=type1
			separator=,
			remove_empty=no
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_demote1_type1}

[/else]
[/if]

	[set_variables]
		name=vra.vaelia_recruit_arr
		mode=replace
		[split]
			list=$vra.vaelia_recruit
			key=type
			separator=,
			remove_empty=yes
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.vaelia_recruit}

	[set_variables]
		name=vra.possible_recruit_arr
		mode=replace
		[split]
			list=$vra.possible_recruit
			key=type
			separator=,
			remove_empty=yes
		[/split]
	[/set_variables]
	{CLEAR_VARIABLE vra.possible_recruit}

	#{LOOKUP_INDEX vra.possible_recruit_arr type "Sergeant" vra.index}
	#{DEBUG_MSG "Before foreach: length= $vra.possible_recruit_arr.length and index=$vra.index and type = $vra.possible_recruit_arr[$vra.index].type"}
	#{CLEAR_VARIABLE vra.index}


    [foreach]
        array=vra.possible_recruit_arr
        variable=this_var
	index_var=i
	readonly=no
        [do]
            [if]
                {VARIABLE_CONDITIONAL this_var.type not_equals $null}
                [then]
			[if]
				[have_unit]
					type=$this_var.type
					search_recall_list=yes
				[/have_unit]
			[then]
				{VRA_ALLOW_UNIT $this_var.type}

				[set_variable]
					name=vra.del_index[$vra.del_index.length].x
					value=$i
				[/set_variable]

				[if]
				[variable]
					name=grant_recruit
					equals=yes
				[/variable]
				[then]
				[set_variable]
					name=vra.vaelia_recruit_arr[$vra.vaelia_recruit_arr.length].type
					value=$this_var.type
				[/set_variable]
				[/then]
				[/if]
				[clear_variable]
					name=grant_recruit
				[/clear_variable]

		                    #[continue]
		                    #[/continue]
			[/then]
			[/if]

                [/then]
            [/if]
        [/do]
    [/foreach]

    [foreach]
        array=vra.del_index
        variable=this_var
	index_var=i
	readonly=no
        [do]
		{CLEAR_VARIABLE vra.possible_recruit_arr[$this_var.x].type}
        [/do]
    [/foreach]
	{CLEAR_VARIABLE vra.del_index}


	#{LOOKUP_INDEX vra.possible_recruit_arr type "Sergeant" vra.index}
	#{DEBUG_MSG "After foreach length = $vra.possible_recruit_arr.length and index = $vra.index and type = $vra.possible_recruit_arr[$vra.index].type"}
	#{CLEAR_VARIABLE vra.index}



# Do demotions here
####################################

# Demote 3
[foreach]
array=vra.vaelia_demote3_arr
variable=this_var
index_var=i
readonly=no
[do]
	[if]
		{VARIABLE_CONDITIONAL this_var.type3 not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type3 vra.index3}
		[if]
			{VARIABLE_CONDITIONAL vra.index3 numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index3}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	[if]
		{VARIABLE_CONDITIONAL this_var.type2 not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type2 vra.index2}
		[if]
			{VARIABLE_CONDITIONAL vra.index2 numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index3}
			{CLEAR_VARIABLE vra.index2}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	[if]
		{VARIABLE_CONDITIONAL this_var.type1 not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type1 vra.index1}
		[if]
			{VARIABLE_CONDITIONAL vra.index1 numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index3}
			{CLEAR_VARIABLE vra.index2}
			{CLEAR_VARIABLE vra.index1}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	[if]
		{VARIABLE_CONDITIONAL this_var.type not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type vra.index}
		[if]
			{VARIABLE_CONDITIONAL vra.index numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index3}
			{CLEAR_VARIABLE vra.index2}
			{CLEAR_VARIABLE vra.index1}
			{CLEAR_VARIABLE vra.index}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	{VRA_DISALLOW_UNIT $this_var.type}
	{CLEAR_VARIABLE vra.vaelia_recruit_arr[$vra.index].type}

	[set_variable]
		name=vra.del_index[$vra.del_index.length].x
		value=$i
	[/set_variable]

	{CLEAR_VARIABLE vra.index3}
	{CLEAR_VARIABLE vra.index2}
	{CLEAR_VARIABLE vra.index1}
	{CLEAR_VARIABLE vra.index}

#	{LOOKUP_INDEX vra.possible_recruit_arr type $this_var.type vra.index}
#	[if]
#	{VARIABLE_CONDITIONAL vra.index less_than $vra.possible_recruit_arr.length}
#	[then]
#		{CLEAR_VARIABLE vra.possible_recruit_arr[$vra.index].type}
#	[/then]
#	[/if]
#	{CLEAR_VARIABLE vra.index}
[/do]
[/foreach]

[foreach]
array=vra.del_index
variable=this_var
index_var=i
readonly=no
[do]
	{CLEAR_VARIABLE vra.vaelia_demote3_arr[$this_var.x].type}
	{CLEAR_VARIABLE vra.vaelia_demote3_arr[$this_var.x].type1}
	{CLEAR_VARIABLE vra.vaelia_demote3_arr[$this_var.x].type2}
	{CLEAR_VARIABLE vra.vaelia_demote3_arr[$this_var.x].type3}
[/do]
[/foreach]
{CLEAR_VARIABLE vra.del_index}

# copy array demote3

{CLEAR_VARIABLE vra.vaelia_demote3_arr_tmp}

[foreach]
array=vra.vaelia_demote3_arr
variable=this_var
index_var=i
readonly=no
[do]
	[if]
		{VARIABLE_CONDITIONAL this_var.type not_equals $null}
	[then]
		[set_variables]
			name=vra.vaelia_demote3_arr_tmp
			mode=append
			[value]
				type=$this_var.type
				type1=$this_var.type1
				type2=$this_var.type2
				type3=$this_var.type3
			[/value]
		[/set_variables]

	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]
[/do]
[/foreach]

{CLEAR_VARIABLE vra.vaelia_demote3_arr}

[set_variable]
	name=vra.vaelia_demote3_type3
	[join]
		variable=vra.vaelia_demote3_arr_tmp
		key=type3
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

[set_variable]
	name=vra.vaelia_demote3_type2
	[join]
		variable=vra.vaelia_demote3_arr_tmp
		key=type2
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

[set_variable]
	name=vra.vaelia_demote3_type1
	[join]
		variable=vra.vaelia_demote3_arr_tmp
		key=type1
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

[set_variable]
	name=vra.vaelia_demote3_type
	[join]
		variable=vra.vaelia_demote3_arr_tmp
		key=type
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

{CLEAR_VARIABLE vra.vaelia_demote3_arr_tmp}

# Demote2

[foreach]
array=vra.vaelia_demote2_arr
variable=this_var
index_var=i
readonly=no
[do]
	[if]
		{VARIABLE_CONDITIONAL this_var.type2 not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type2 vra.index2}
		[if]
			{VARIABLE_CONDITIONAL vra.index2 numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index2}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	[if]
		{VARIABLE_CONDITIONAL this_var.type1 not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type1 vra.index1}
		[if]
			{VARIABLE_CONDITIONAL vra.index1 numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index2}
			{CLEAR_VARIABLE vra.index1}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	[if]
		{VARIABLE_CONDITIONAL this_var.type not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type vra.index}
		[if]
			{VARIABLE_CONDITIONAL vra.index numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index2}
			{CLEAR_VARIABLE vra.index1}
			{CLEAR_VARIABLE vra.index}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	{VRA_DISALLOW_UNIT $this_var.type}
	{CLEAR_VARIABLE vra.vaelia_recruit_arr[$vra.index].type}

	[set_variable]
		name=vra.del_index[$vra.del_index.length].x
		value=$i
	[/set_variable]

	{CLEAR_VARIABLE vra.index2}
	{CLEAR_VARIABLE vra.index1}
	{CLEAR_VARIABLE vra.index}

#	{LOOKUP_INDEX vra.possible_recruit_arr type $this_var.type vra.index}
#	[if]
#	{VARIABLE_CONDITIONAL vra.index less_than $vra.possible_recruit_arr.length}
#	[then]
#		{CLEAR_VARIABLE vra.possible_recruit_arr[$vra.index].type}
#	[/then]
#	[/if]
#	{CLEAR_VARIABLE vra.index}
[/do]
[/foreach]

[foreach]
array=vra.del_index
variable=this_var
index_var=i
readonly=no
[do]
	{CLEAR_VARIABLE vra.vaelia_demote2_arr[$this_var.x].type}
	{CLEAR_VARIABLE vra.vaelia_demote2_arr[$this_var.x].type1}
	{CLEAR_VARIABLE vra.vaelia_demote2_arr[$this_var.x].type2}
[/do]
[/foreach]
{CLEAR_VARIABLE vra.del_index}

# copy array demote2

{CLEAR_VARIABLE vra.vaelia_demote2_arr_tmp}

[foreach]
array=vra.vaelia_demote2_arr
variable=this_var
index_var=i
readonly=no
[do]
	[if]
		{VARIABLE_CONDITIONAL this_var.type not_equals $null}
	[then]
		[set_variables]
			name=vra.vaelia_demote2_arr_tmp
			mode=append
			[value]
				type=$this_var.type
				type1=$this_var.type1
				type2=$this_var.type2
			[/value]
		[/set_variables]

	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]
[/do]
[/foreach]

{CLEAR_VARIABLE vra.vaelia_demote2_arr}

[set_variable]
	name=vra.vaelia_demote2_type2
	[join]
		variable=vra.vaelia_demote2_arr_tmp
		key=type2
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

[set_variable]
	name=vra.vaelia_demote2_type1
	[join]
		variable=vra.vaelia_demote2_arr_tmp
		key=type1
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

[set_variable]
	name=vra.vaelia_demote2_type
	[join]
		variable=vra.vaelia_demote2_arr_tmp
		key=type
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

{CLEAR_VARIABLE vra.vaelia_demote2_arr_tmp}

# Demote 1

[foreach]
array=vra.vaelia_demote1_arr
variable=this_var
index_var=i
readonly=no
[do]
	[if]
		{VARIABLE_CONDITIONAL this_var.type1 not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type1 vra.index1}
		[if]
			{VARIABLE_CONDITIONAL vra.index1 numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index1}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	[if]
		{VARIABLE_CONDITIONAL this_var.type not_equals $null}
	[then]
		{LOOKUP_INDEX vra.vaelia_recruit_arr type $this_var.type vra.index}
		[if]
			{VARIABLE_CONDITIONAL vra.index numerical_equals $vra.vaelia_recruit_arr.length}
		[then]
			{CLEAR_VARIABLE vra.index1}
			{CLEAR_VARIABLE vra.index}
			[continue][/continue]
		[/then]
		[/if]
	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]

	{VRA_DISALLOW_UNIT $this_var.type}
	{CLEAR_VARIABLE vra.vaelia_recruit_arr[$vra.index].type}

	[set_variable]
		name=vra.del_index[$vra.del_index.length].x
		value=$i
	[/set_variable]

	{CLEAR_VARIABLE vra.index1}
	{CLEAR_VARIABLE vra.index}

#	{LOOKUP_INDEX vra.possible_recruit_arr type $this_var.type vra.index}
#	[if]
#	{VARIABLE_CONDITIONAL vra.index less_than $vra.possible_recruit_arr.length}
#	[then]
#		{CLEAR_VARIABLE vra.possible_recruit_arr[$vra.index].type}
#	[/then]
#	[/if]
#	{CLEAR_VARIABLE vra.index}
[/do]
[/foreach]

[foreach]
array=vra.del_index
variable=this_var
index_var=i
readonly=no
[do]
	{CLEAR_VARIABLE vra.vaelia_demote1_arr[$this_var.x].type}
	{CLEAR_VARIABLE vra.vaelia_demote1_arr[$this_var.x].type1}
[/do]
[/foreach]
{CLEAR_VARIABLE vra.del_index}

# copy array demote1

{CLEAR_VARIABLE vra.vaelia_demote1_arr_tmp}

[foreach]
array=vra.vaelia_demote1_arr
variable=this_var
index_var=i
readonly=no
[do]
	[if]
		{VARIABLE_CONDITIONAL this_var.type not_equals $null}
	[then]
		[set_variables]
			name=vra.vaelia_demote1_arr_tmp
			mode=append
			[value]
				type=$this_var.type
				type1=$this_var.type1
			[/value]
		[/set_variables]

	[/then]
	[else]
		[continue][/continue]
	[/else]
	[/if]
[/do]
[/foreach]

{CLEAR_VARIABLE vra.vaelia_demote1_arr}

[set_variable]
	name=vra.vaelia_demote1_type1
	[join]
		variable=vra.vaelia_demote1_arr_tmp
		key=type1
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

[set_variable]
	name=vra.vaelia_demote1_type
	[join]
		variable=vra.vaelia_demote1_arr_tmp
		key=type
		separator=,
		remove_empty=no
	[/join]
[/set_variable]

{CLEAR_VARIABLE vra.vaelia_demote1_arr_tmp}

####################################

            [set_variable]
                name=vra.possible_recruit
                [join]
                    variable=vra.possible_recruit_arr
                    key=type
                    separator=,
                    remove_empty=yes
                [/join]
            [/set_variable]
	{CLEAR_VARIABLE vra.possible_recruit_arr}

[set_variable]
	name=vra.vaelia_recruit
	[join]
		variable=vra.vaelia_recruit_arr
		key=type
		separator=,
		remove_empty=yes
	[/join]
[/set_variable]
{CLEAR_VARIABLE vra.vaelia_recruit_arr}

# {DEBUG_MSG $arr[0].foo}
# {DEBUG_MSG $arr[1].foo}

		{VRA_SIDE_ONE_GOLD}
	[/event]
# {STARTING_VILLAGES_ALL 1}
[/scenario]

#undef VRA_VILLAGE
